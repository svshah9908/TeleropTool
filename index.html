<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleROP Risk Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <div id="disclaimer-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-[100] flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-lg w-full mx-4 border-t-8 border-red-700">
            <h2 class="text-2xl font-bold text-red-700 mb-4 flex items-center gap-2">
                ⚠️ Clinical Disclaimer
            </h2>
            <div class="text-gray-700 space-y-3 mb-6 text-sm">
                <p>This ROP Monitoring tool and its predictive risk thresholds are intended for <strong>research and educational purposes only</strong>.</p>
                <p>The algorithms and models used to generate "High Risk" and "Moderate Risk" zones are based on historical retrospective data and have not been cleared by the FDA.</p>
                <p><strong>This tool does not replace professional clinical judgment.</strong> All diagnostic and treatment decisions, including follow-up intervals and the need for intervention, must be made by a qualified medical professional based on their direct examination of the patient.</p>
            </div>
            <div class="text-right border-t pt-4">
                <button onclick="acceptDisclaimer()" class="bg-[#8C1515] text-white px-6 py-2 rounded shadow hover:bg-[#731010] transition font-bold">I Acknowledge</button>
            </div>
        </div>
    </div>

    <nav class="bg-[#8C1515] text-white shadow-md relative z-50">
        <div class="max-w-6xl mx-auto px-6 py-3 flex items-center justify-between">
            <div class="font-bold text-xl tracking-wide flex items-center gap-2">
                TeleROP Risk Tool
            </div>
            <div class="flex gap-2 md:gap-6 text-sm font-medium">
                <div class="relative group">
                    <button onclick="toggleNav('nav-when')" class="hover:text-red-200 focus:outline-none flex items-center gap-1 py-1">When to Use <span class="text-xs">▼</span></button>
                    <div id="nav-when" class="hidden absolute right-0 top-full mt-2 w-72 bg-white text-gray-800 p-4 rounded shadow-xl border border-gray-200">
                        <h4 class="font-bold mb-2 text-[#8C1515] border-b pb-1">When to Use</h4>
                        <p class="text-xs leading-relaxed">Use this tool during routine ROP screening exams to objectively track tROP-SS trajectories. It is particularly useful for identifying infants whose disease velocity places them at high risk for progressing to treatment-warranted ROP (TW-ROP) within the next 1 to 2 weeks.</p>
                    </div>
                </div>
                <div class="relative group">
                    <button onclick="toggleNav('nav-pearls')" class="hover:text-red-200 focus:outline-none flex items-center gap-1 py-1">Pearls/Pitfalls <span class="text-xs">▼</span></button>
                    <div id="nav-pearls" class="hidden absolute right-0 top-full mt-2 w-80 bg-white text-gray-800 p-4 rounded shadow-xl border border-gray-200">
                        <h4 class="font-bold mb-2 text-[#8C1515] border-b pb-1">Pearls & Pitfalls</h4>
                        <ul class="text-xs leading-relaxed space-y-2">
                            <li><strong class="text-green-700">Pearl:</strong> Consistent clinical grading of Zone, Stage, and Plus disease is critical for accurate risk prediction.</li>
                            <li><strong class="text-green-700">Pearl:</strong> Entering the patient's exact Birth Weight and EGA tailors the risk shading specifically to their baseline demographic risk.</li>
                            <li><strong class="text-red-700">Pitfall:</strong> AROP (Aggressive ROP) cases may not follow standard kinetic models. Always rely on exam findings over the predictive chart for atypical presentations.</li>
                        </ul>
                    </div>
                </div>
                <div class="relative group">
                    <button onclick="toggleNav('nav-why')" class="hover:text-red-200 focus:outline-none flex items-center gap-1 py-1">Why Use <span class="text-xs">▼</span></button>
                    <div id="nav-why" class="hidden absolute right-0 top-full mt-2 w-72 bg-white text-gray-800 p-4 rounded shadow-xl border border-gray-200">
                        <h4 class="font-bold mb-2 text-[#8C1515] border-b pb-1">Why Use</h4>
                        <p class="text-xs leading-relaxed">By translating qualitative exam findings into a standardized quantitative score (tROP-SS), this tool helps clinicians visually synthesize disease progression. The dynamic risk zones optimize follow-up intervals by highlighting when an infant is crossing into high-risk statistical territory.</p>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="p-6">
        <div id="dashboard-view" class="max-w-5xl mx-auto">
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="text-3xl font-bold text-[#8C1515]">Patient Dashboard</h1>
                <div class="flex gap-3">
                    <input type="file" id="import-file" accept=".csv" class="hidden" onchange="importCSV(event)">
                    <button onclick="document.getElementById('import-file').click()" class="bg-gray-600 text-white px-4 py-2 rounded shadow hover:bg-gray-700 transition">Import CSV</button>
                    <button onclick="exportCSV()" class="bg-[#8C1515] text-white px-4 py-2 rounded shadow hover:bg-[#731010] transition">Export CSV</button>
                </div>
            </div>

            <div id="server-warning" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded shadow-sm">
                <h3 class="font-bold">⚠️ Local Server Required for Predictive Models</h3>
                <p class="text-sm mt-1">The web browser blocked loading the modular CSV files. To fix this, open your Mac Terminal, go to this folder, and run: <code class="bg-red-200 px-1 rounded font-mono">python3 -m http.server 8000</code>. Then go to <a href="http://localhost:8000" class="underline font-bold">http://localhost:8000</a> in your browser.</p>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 id="form-title" class="text-xl font-semibold mb-4 text-gray-800">Add New Patient</h2>
                <form id="new-patient-form" class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">EGA (Weeks)</label>
                        <input type="number" id="ega-weeks" min="20" max="40" required class="border rounded p-2 w-24">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">EGA (Days)</label>
                        <input type="number" id="ega-days" min="0" max="6" required class="border rounded p-2 w-24">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Sex</label>
                        <select id="pt-sex" class="border rounded p-2 w-24">
                            <option value="M">M</option>
                            <option value="F">F</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Birth Weight (g)</label>
                        <input type="number" id="pt-bw" required class="border rounded p-2 w-32">
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" id="submit-btn" class="bg-[#8C1515] text-white px-4 py-2 rounded hover:bg-[#731010] transition font-medium">Create Patient</button>
                        <button type="button" id="cancel-btn" onclick="cancelEdit()" class="hidden bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 transition font-medium">Cancel</button>
                    </div>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Patient List</h2>
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100 border-b">
                            <th class="p-3 text-sm font-semibold text-gray-600">ID</th>
                            <th class="p-3 text-sm font-semibold text-gray-600">EGA</th>
                            <th class="p-3 text-sm font-semibold text-gray-600">Sex</th>
                            <th class="p-3 text-sm font-semibold text-gray-600">Birth Weight</th>
                            <th class="p-3 text-sm font-semibold text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="patient-list-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="patient-view" class="max-w-5xl mx-auto hidden">
            <button onclick="goBack()" class="mb-4 text-[#8C1515] hover:text-[#731010] font-medium transition">&larr; Back to Dashboard</button>
            
            <div id="demo-display" class="bg-white p-4 rounded-lg shadow-md mb-6 flex justify-between items-center border-l-4 border-[#8C1515]">
                <div class="flex flex-wrap gap-6 items-center">
                    <div><span class="text-sm text-gray-500">Patient ID:</span> <span id="hdr-id" class="font-bold text-lg text-gray-800"></span></div>
                    <div><span class="text-sm text-gray-500">EGA:</span> <span id="hdr-ega" class="font-bold text-lg text-gray-800"></span></div>
                    <div><span class="text-sm text-gray-500">Sex:</span> <span id="hdr-sex" class="font-bold text-lg text-gray-800"></span></div>
                    <div><span class="text-sm text-gray-500">Birth Weight:</span> <span id="hdr-bw" class="font-bold text-lg text-gray-800"></span>g</div>
                </div>
                <div class="flex gap-2 ml-4">
                    <button onclick="startInlineEdit()" class="bg-gray-100 text-gray-700 px-3 py-1.5 rounded hover:bg-gray-200 transition text-sm font-semibold whitespace-nowrap">Edit Info</button>
                    <button onclick="exportToPDF()" class="bg-gray-800 text-white px-3 py-1.5 rounded hover:bg-gray-900 transition text-sm font-semibold whitespace-nowrap shadow-sm">Export PDF</button>
                </div>
            </div>

            <div id="demo-edit" class="hidden bg-white p-4 rounded-lg shadow-md mb-6 border-l-4 border-[#8C1515]">
                <form id="inline-patient-form" class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="block text-xs font-medium text-gray-500">Patient ID</label>
                        <input type="text" id="inline-pt-id" readonly class="border border-gray-300 rounded p-1.5 w-24 bg-gray-100 cursor-not-allowed text-gray-600" title="ID cannot be changed">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500">EGA (Wks)</label>
                        <input type="number" id="inline-ega-weeks" min="20" max="40" required class="border border-gray-300 rounded p-1.5 w-16">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500">EGA (Days)</label>
                        <input type="number" id="inline-ega-days" min="0" max="6" required class="border border-gray-300 rounded p-1.5 w-16">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500">Sex</label>
                        <select id="inline-pt-sex" class="border border-gray-300 rounded p-1.5 w-16">
                            <option value="M">M</option>
                            <option value="F">F</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500">BW (g)</label>
                        <input type="number" id="inline-pt-bw" required class="border border-gray-300 rounded p-1.5 w-24">
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="bg-[#8C1515] text-white px-4 py-1.5 rounded hover:bg-[#731010] transition text-sm font-medium">Save</button>
                        <button type="button" onclick="cancelInlineEdit()" class="bg-gray-400 text-white px-4 py-1.5 rounded hover:bg-gray-500 transition text-sm font-medium">Cancel</button>
                    </div>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6 relative h-[400px]">
                <canvas id="ropChart"></canvas>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md col-span-1 h-fit">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="visit-form-title" class="font-bold text-lg text-gray-800">Log New Visit</h3>
                    </div>

                    <form id="new-visit-form" class="flex flex-col gap-4">

                        <div class="flex gap-2">
                            <div class="w-1/3">
                                <label class="block text-xs font-semibold text-gray-600 mb-1">PMA (Wks)</label>
                                <input type="number" id="visit-weeks" min="30" max="40" required class="border border-gray-300 rounded p-2 w-full focus:ring-[#8C1515] focus:border-[#8C1515]">
                            </div>
                            <div class="w-1/3">
                                <label class="block text-xs font-semibold text-gray-600 mb-1">PMA (Days)</label>
                                <input type="number" id="visit-days" min="0" max="6" required class="border border-gray-300 rounded p-2 w-full focus:ring-[#8C1515] focus:border-[#8C1515]">
                            </div>
                            <div class="w-1/3">
                                <label class="block text-xs font-semibold text-gray-800 mb-1">Current Wt (g)</label>
                                <input type="number" id="visit-weight" min="0" class="border border-gray-300 rounded p-2 w-full focus:ring-[#8C1515] focus:border-[#8C1515]">
                            </div>
                        </div>

                        <div id="zsp-inputs" class="flex flex-col gap-4 mt-2">
                            
                            <div class="border p-3 rounded-lg bg-blue-50 relative shadow-sm">
                                <h4 class="font-bold text-blue-800 mb-3 border-b border-blue-200 pb-1 flex justify-between items-center">
                                    <span>Right Eye (OD)</span>
                                    <span id="od-calc-score" class="text-xl font-black text-blue-900 bg-white px-2 py-0.5 rounded shadow-sm">--</span>
                                </h4>
                                
                                <div class="mb-3 bg-blue-100 p-2 rounded border border-blue-200 flex items-center gap-2 transition hover:bg-blue-200">
                                    <input type="checkbox" id="od-arop" onchange="updateCalc()" class="w-4 h-4 cursor-pointer accent-blue-600">
                                    <label for="od-arop" class="text-sm font-bold text-blue-900 cursor-pointer select-none">AROP (Aggressive ROP)</label>
                                </div>

                                <div class="mb-2">
                                    <span class="text-xs font-semibold text-gray-600 block mb-1 uppercase tracking-wider">Zone</span>
                                    <div class="flex gap-1">
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="od-zone" value="30" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-blue-200 rounded peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 bg-white hover:bg-blue-50 transition">ZI</div></label>
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="od-zone" value="20" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-blue-200 rounded peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 bg-white hover:bg-blue-50 transition">PZII</div></label>
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="od-zone" value="15" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-blue-200 rounded peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 bg-white hover:bg-blue-50 transition">ZII</div></label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <span class="text-xs font-semibold text-gray-600 block mb-1 uppercase tracking-wider">Stage</span>
                                    <div class="flex gap-1">
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="od-stage" value="0" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-blue-200 rounded peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 bg-white hover:bg-blue-50 transition">0</div></label>
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="od-stage" value="3" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-blue-200 rounded peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 bg-white hover:bg-blue-50 transition">1</div></label>
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="od-stage" value="10" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-blue-200 rounded peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 bg-white hover:bg-blue-50 transition">2</div></label>
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="od-stage" value="25" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-blue-200 rounded peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 bg-white hover:bg-blue-50 transition">3</div></label>
                                    </div>
                                </div>
                                <div class="bg-white p-2 rounded shadow-sm flex items-center justify-between border border-blue-100">
                                    <div class="flex-1">
                                        <span class="text-xs font-semibold text-gray-600 block mb-1 uppercase tracking-wider">Plus</span>
                                        <div class="flex gap-1">
                                            <label class="cursor-pointer flex-1 text-center"><input type="radio" name="od-plus" value="0" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1 text-xs font-medium border border-blue-200 rounded peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 bg-gray-50 hover:bg-blue-50 transition">None</div></label>
                                            <label class="cursor-pointer flex-1 text-center"><input type="radio" name="od-plus" value="5" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1 text-xs font-medium border border-blue-200 rounded peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 bg-gray-50 hover:bg-blue-50 transition">Pre</div></label>
                                            <label class="cursor-pointer flex-1 text-center"><input type="radio" name="od-plus" value="30" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1 text-xs font-medium border border-blue-200 rounded peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 bg-gray-50 hover:bg-blue-50 transition">Plus</div></label>
                                        </div>
                                    </div>
                                    <div class="ml-3 pl-3 border-l border-gray-200">
                                        <span class="text-xs font-semibold text-gray-600 block mb-1 uppercase tracking-wider">P-Score</span>
                                        <select id="od-pscore" class="border border-blue-300 rounded p-1 text-sm bg-blue-50 text-blue-900 cursor-pointer w-14 text-center focus:ring-blue-500 font-medium">
                                            <option value="">-</option>
                                            <option value="1">1</option><option value="2">2</option>
                                            <option value="3">3</option><option value="4">4</option>
                                            <option value="5">5</option><option value="6">6</option>
                                            <option value="7">7</option><option value="8">8</option>
                                            <option value="9">9</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="border p-3 rounded-lg bg-green-50 relative shadow-sm">
                                <h4 class="font-bold text-green-800 mb-3 border-b border-green-200 pb-1 flex justify-between items-center">
                                    <span>Left Eye (OS)</span>
                                    <span id="os-calc-score" class="text-xl font-black text-green-900 bg-white px-2 py-0.5 rounded shadow-sm">--</span>
                                </h4>
                                
                                <div class="mb-3 bg-green-100 p-2 rounded border border-green-200 flex items-center gap-2 transition hover:bg-green-200">
                                    <input type="checkbox" id="os-arop" onchange="updateCalc()" class="w-4 h-4 cursor-pointer accent-green-600">
                                    <label for="os-arop" class="text-sm font-bold text-green-900 cursor-pointer select-none">AROP (Aggressive ROP)</label>
                                </div>

                                <div class="mb-2">
                                    <span class="text-xs font-semibold text-gray-600 block mb-1 uppercase tracking-wider">Zone</span>
                                    <div class="flex gap-1">
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="os-zone" value="30" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-green-200 rounded peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 bg-white hover:bg-green-50 transition">ZI</div></label>
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="os-zone" value="20" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-green-200 rounded peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 bg-white hover:bg-green-50 transition">PZII</div></label>
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="os-zone" value="15" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-green-200 rounded peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 bg-white hover:bg-green-50 transition">ZII</div></label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <span class="text-xs font-semibold text-gray-600 block mb-1 uppercase tracking-wider">Stage</span>
                                    <div class="flex gap-1">
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="os-stage" value="0" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-green-200 rounded peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 bg-white hover:bg-green-50 transition">0</div></label>
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="os-stage" value="3" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-green-200 rounded peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 bg-white hover:bg-green-50 transition">1</div></label>
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="os-stage" value="10" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-green-200 rounded peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 bg-white hover:bg-green-50 transition">2</div></label>
                                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="os-stage" value="25" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1.5 text-xs font-medium border border-green-200 rounded peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 bg-white hover:bg-green-50 transition">3</div></label>
                                    </div>
                                </div>
                                <div class="bg-white p-2 rounded shadow-sm flex items-center justify-between border border-green-100">
                                    <div class="flex-1">
                                        <span class="text-xs font-semibold text-gray-600 block mb-1 uppercase tracking-wider">Plus</span>
                                        <div class="flex gap-1">
                                            <label class="cursor-pointer flex-1 text-center"><input type="radio" name="os-plus" value="0" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1 text-xs font-medium border border-green-200 rounded peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 bg-gray-50 hover:bg-green-50 transition">None</div></label>
                                            <label class="cursor-pointer flex-1 text-center"><input type="radio" name="os-plus" value="5" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1 text-xs font-medium border border-green-200 rounded peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 bg-gray-50 hover:bg-green-50 transition">Pre</div></label>
                                            <label class="cursor-pointer flex-1 text-center"><input type="radio" name="os-plus" value="30" class="peer sr-only" onchange="updateCalc()"><div class="px-1 py-1 text-xs font-medium border border-green-200 rounded peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 bg-gray-50 hover:bg-green-50 transition">Plus</div></label>
                                        </div>
                                    </div>
                                    <div class="ml-3 pl-3 border-l border-gray-200">
                                        <span class="text-xs font-semibold text-gray-600 block mb-1 uppercase tracking-wider">P-Score</span>
                                        <select id="os-pscore" class="border border-green-300 rounded p-1 text-sm bg-green-50 text-green-900 cursor-pointer w-14 text-center focus:ring-green-500 font-medium">
                                            <option value="">-</option>
                                            <option value="1">1</option><option value="2">2</option>
                                            <option value="3">3</option><option value="4">4</option>
                                            <option value="5">5</option><option value="6">6</option>
                                            <option value="7">7</option><option value="8">8</option>
                                            <option value="9">9</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-between px-1">
                                <button type="button" onclick="clearRadios('od')" class="text-xs text-blue-600 hover:text-blue-800 hover:underline font-medium">Clear OD Selection</button>
                                <button type="button" onclick="clearRadios('os')" class="text-xs text-green-600 hover:text-green-800 hover:underline font-medium">Clear OS Selection</button>
                            </div>
                        </div>

                        <div class="flex gap-2 mt-4">
                            <button type="submit" id="submit-visit-btn" class="flex-1 bg-[#8C1515] text-white px-4 py-2.5 rounded shadow hover:bg-[#731010] transition font-bold text-lg">Add Data Point</button>
                            <button type="button" id="cancel-visit-btn" onclick="cancelVisitEdit()" class="hidden bg-gray-400 text-white px-4 py-2.5 rounded shadow hover:bg-gray-500 transition font-bold text-lg">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md col-span-2">
                    <h3 class="font-bold text-lg text-gray-800 mb-4">Visit History</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse min-w-[500px]">
                            <thead>
                                <tr class="bg-gray-100 border-b border-gray-200">
                                    <th class="p-3 text-sm font-semibold text-gray-700">PMA</th>
                                    <th class="p-3 text-sm font-semibold text-blue-800">OD Score</th>
                                    <th class="p-3 text-sm font-semibold text-green-800">OS Score</th>
                                    <th class="p-3 text-sm font-semibold text-gray-800">Current Wt</th>
                                    <th class="p-3 text-sm font-semibold text-gray-700 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="visit-list-body" class="text-sm">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // UI & NAVIGATION LOGIC
        // ==========================================
        
        document.addEventListener("DOMContentLoaded", () => {
            if (!sessionStorage.getItem("ropDisclaimerAccepted")) {
                document.getElementById("disclaimer-modal").classList.remove("hidden");
            }
        });

        function acceptDisclaimer() {
            sessionStorage.setItem("ropDisclaimerAccepted", "true");
            document.getElementById("disclaimer-modal").classList.add("hidden");
        }

        function toggleNav(id) {
            const menus = ['nav-when', 'nav-pearls', 'nav-why'];
            menus.forEach(menu => {
                if(menu === id) {
                    document.getElementById(menu).classList.toggle('hidden');
                } else {
                    document.getElementById(menu).classList.add('hidden');
                }
            });
        }

        document.addEventListener('click', (e) => {
            if(!e.target.closest('.group')) {
                ['nav-when', 'nav-pearls', 'nav-why'].forEach(m => document.getElementById(m).classList.add('hidden'));
            }
        });

        // ==========================================
        // DATA STATE & EXTERNAL CSV FETCHING
        // ==========================================
        let thresholdData1w = null;
        let thresholdData2w = null;

        let patients = [];
        let currentPatientId = null;
        let editingPatientId = null;
        let editingVisitIndex = null; 
        let chartInstance = null;

        let odCalculatedScore = null;
        let osCalculatedScore = null;

        const dashboardView = document.getElementById('dashboard-view');
        const patientView = document.getElementById('patient-view');
        const patientListBody = document.getElementById('patient-list-body');
        const visitListBody = document.getElementById('visit-list-body');
        
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const ptForm = document.getElementById('new-patient-form');

        const visitFormTitle = document.getElementById('visit-form-title');
        const submitVisitBtn = document.getElementById('submit-visit-btn');
        const cancelVisitBtn = document.getElementById('cancel-visit-btn');

        const customCanvasBackgroundColor = {
            id: 'customCanvasBackgroundColor',
            beforeDraw: (chart) => {
                const ctx = chart.canvas.getContext('2d');
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
            }
        };

        function parseThresholds(csvText) {
            const dataMap = {};
            const lines = csvText.trim().split('\n');
            for(let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',');
                if (cols.length < 14) continue;

                const ega = parseInt(cols[0]);
                const bw = parseInt(cols[1]);
                const sex = cols[2];
                
                if(!dataMap[ega]) dataMap[ega] = {};
                if(!dataMap[ega][bw]) dataMap[ega][bw] = {};
                
                const pmaObj = {};
                for(let p = 30; p <= 40; p++) {
                    pmaObj[p] = parseFloat(cols[p - 30 + 3]);
                }
                dataMap[ega][bw][sex] = pmaObj;
            }
            return dataMap;
        }

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const [res1, res2] = await Promise.all([
                    fetch('1w_predictive_ropss_thresholds.csv').catch(() => null),
                    fetch('2w_predictive_ropss_thresholds.csv').catch(() => null)
                ]);
                
                if (res1 && res1.ok) thresholdData1w = parseThresholds(await res1.text());
                if (res2 && res2.ok) thresholdData2w = parseThresholds(await res2.text());
                
                if (!thresholdData1w || !thresholdData2w) {
                    document.getElementById('server-warning').classList.remove('hidden');
                }
            } catch (e) {
                console.error("Fetch failed.", e);
                document.getElementById('server-warning').classList.remove('hidden');
            }

            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('data');
            if (sharedData) {
                try {
                    const decodedPt = JSON.parse(decodeURIComponent(atob(sharedData)));
                    if (!patients.find(p => p.id === decodedPt.id)) {
                        patients.push(decodedPt);
                    }
                    renderDashboard();
                    setTimeout(() => {
                        openPatient(decodedPt.id);
                    }, 150);
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (e) {
                    console.error("Failed to parse shared link data", e);
                    alert("The shared patient link is invalid or corrupted.");
                }
            }
        });

        // --- GENERATE RANDOM ID --- //
        function generatePatientId() {
            let newId;
            do {
                newId = 'PT-' + Math.floor(10000 + Math.random() * 90000); 
            } while (patients.find(p => p.id === newId));
            return newId;
        }

        // --- DASHBOARD LOGIC --- //
        ptForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const egaWeeksVal = parseInt(document.getElementById('ega-weeks').value);
            const egaDaysVal = parseInt(document.getElementById('ega-days').value);
            const sexVal = document.getElementById('pt-sex').value;
            const bwVal = parseInt(document.getElementById('pt-bw').value);

            if (editingPatientId) {
                const ptIndex = patients.findIndex(p => p.id === editingPatientId);
                patients[ptIndex].egaWeeks = egaWeeksVal;
                patients[ptIndex].egaDays = egaDaysVal;
                patients[ptIndex].sex = sexVal;
                patients[ptIndex].bw = bwVal;
                cancelEdit(); 
            } else {
                const autoId = generatePatientId();
                patients.push({
                    id: autoId, 
                    egaWeeks: egaWeeksVal, 
                    egaDays: egaDaysVal, 
                    sex: sexVal, 
                    bw: bwVal, 
                    visits: []
                });
                this.reset();
            }
            renderDashboard();
        });

        function renderDashboard() {
            patientListBody.innerHTML = '';
            patients.forEach(pt => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="p-3 font-semibold text-[#8C1515] cursor-pointer" onclick="openPatient('${pt.id}')">${pt.id}</td>
                    <td class="p-3 cursor-pointer" onclick="openPatient('${pt.id}')">${pt.egaWeeks}w ${pt.egaDays}d</td>
                    <td class="p-3 cursor-pointer" onclick="openPatient('${pt.id}')">${pt.sex}</td>
                    <td class="p-3 cursor-pointer" onclick="openPatient('${pt.id}')">${pt.bw}g</td>
                    <td class="p-3">
                        <button onclick="editPatient('${pt.id}')" class="text-sm font-semibold text-gray-500 hover:text-[#8C1515] mr-4 transition">Edit</button>
                        <button onclick="deletePatient('${pt.id}')" class="text-sm font-semibold text-red-500 hover:text-red-700 transition">Delete</button>
                    </td>
                `;
                patientListBody.appendChild(tr);
            });
        }

        function editPatient(id) {
            editingPatientId = id;
            const pt = patients.find(p => p.id === id);
            document.getElementById('ega-weeks').value = pt.egaWeeks;
            document.getElementById('ega-days').value = pt.egaDays;
            document.getElementById('pt-sex').value = pt.sex;
            document.getElementById('pt-bw').value = pt.bw;

            formTitle.innerText = "Edit Patient: " + pt.id;
            submitBtn.innerText = "Update Patient";
            cancelBtn.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEdit() {
            editingPatientId = null;
            ptForm.reset();
            formTitle.innerText = "Add New Patient";
            submitBtn.innerText = "Create Patient";
            cancelBtn.classList.add('hidden');
        }

        function deletePatient(id) {
            if(confirm(`Are you sure you want to completely delete patient ${id} and all their visit data?`)) {
                patients = patients.filter(p => p.id !== id);
                if (editingPatientId === id) cancelEdit();
                renderDashboard();
            }
        }

        // --- PATIENT CHART LOGIC --- //
        function openPatient(id) {
            currentPatientId = id;
            cancelVisitEdit(); 
            cancelInlineEdit();
            dashboardView.classList.add('hidden');
            patientView.classList.remove('hidden');
            
            const pt = patients.find(p => p.id === id);
            document.getElementById('hdr-id').innerText = pt.id;
            document.getElementById('hdr-ega').innerText = `${pt.egaWeeks}w ${pt.egaDays}d`;
            document.getElementById('hdr-sex').innerText = pt.sex;
            document.getElementById('hdr-bw').innerText = pt.bw;

            renderVisits();
            updateChart();
        }

        function goBack() {
            patientView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            currentPatientId = null;
            cancelVisitEdit();
            cancelInlineEdit();
        }

        // --- INLINE DEMOGRAPHICS EDITING --- //
        function startInlineEdit() {
            const pt = patients.find(p => p.id === currentPatientId);
            document.getElementById('inline-pt-id').value = pt.id;
            document.getElementById('inline-ega-weeks').value = pt.egaWeeks;
            document.getElementById('inline-ega-days').value = pt.egaDays;
            document.getElementById('inline-pt-sex').value = pt.sex;
            document.getElementById('inline-pt-bw').value = pt.bw;
            
            document.getElementById('demo-display').classList.add('hidden');
            document.getElementById('demo-edit').classList.remove('hidden');
        }

        function cancelInlineEdit() {
            document.getElementById('demo-edit').classList.add('hidden');
            document.getElementById('demo-display').classList.remove('hidden');
        }

        document.getElementById('inline-patient-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const egaWeeksVal = parseInt(document.getElementById('inline-ega-weeks').value);
            const egaDaysVal = parseInt(document.getElementById('inline-ega-days').value);
            const sexVal = document.getElementById('inline-pt-sex').value;
            const bwVal = parseInt(document.getElementById('inline-pt-bw').value);

            const ptIndex = patients.findIndex(p => p.id === currentPatientId);
            patients[ptIndex].egaWeeks = egaWeeksVal;
            patients[ptIndex].egaDays = egaDaysVal;
            patients[ptIndex].sex = sexVal;
            patients[ptIndex].bw = bwVal;
            
            renderDashboard(); 
            
            document.getElementById('hdr-id').innerText = patients[ptIndex].id;
            document.getElementById('hdr-ega').innerText = `${patients[ptIndex].egaWeeks}w ${patients[ptIndex].egaDays}d`;
            document.getElementById('hdr-sex').innerText = patients[ptIndex].sex;
            document.getElementById('hdr-bw').innerText = patients[ptIndex].bw;

            cancelInlineEdit();
            updateChart(); 
        });

        // --- EXPORT TO PDF & GENERATE SHARE LINK --- //
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const pt = patients.find(p => p.id === currentPatientId);
            
            const exportPt = JSON.parse(JSON.stringify(pt));
            exportPt.id = "ANON-" + btoa(pt.id).replace(/=/g, '').substring(0, 6).toUpperCase();
            
            const encodedPayload = btoa(encodeURIComponent(JSON.stringify(exportPt)));
            const shareLink = window.location.origin + window.location.pathname + '?data=' + encodedPayload;

            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.setTextColor(140, 21, 21); // Stanford Cardinal
            doc.text("TeleROP Risk Tool - Patient Report", 14, 22);
            
            doc.setFontSize(12);
            doc.setTextColor(75, 85, 99); 
            doc.text(`Patient ID: ${exportPt.id} (Scrambled)`, 14, 32);
            doc.text(`EGA: ${exportPt.egaWeeks}w ${exportPt.egaDays}d`, 14, 38);
            doc.text(`Sex: ${exportPt.sex}`, 100, 32);
            doc.text(`Birth Weight: ${exportPt.bw}g`, 100, 38);
            
            const canvas = document.getElementById('ropChart');
            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            doc.addImage(imgData, 'JPEG', 14, 45, 180, 80);
            
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text("Visit History:", 14, 135);
            
            doc.setFontSize(10);
            let y = 145;
            doc.setFont(undefined, 'bold');
            doc.text("PMA", 14, y);
            doc.text("OD Score", 60, y);
            doc.text("OS Score", 95, y);
            doc.text("Current Wt", 130, y);
            doc.setFont(undefined, 'normal');
            y += 8;
            
            exportPt.visits.forEach(v => {
                doc.text(`${v.weeks}w ${v.days}d`, 14, y);
                
                let odText = v.scoreRight !== null ? v.scoreRight : '--';
                if (v.od && v.od.arop) {
                    odText = "85 (AROP)";
                } else if (v.scoreRight >= 55) {
                    odText = `${v.scoreRight} (TW-ROP)`;
                }
                
                let osText = v.scoreLeft !== null ? v.scoreLeft : '--';
                if (v.os && v.os.arop) {
                    osText = "85 (AROP)";
                } else if (v.scoreLeft >= 55) {
                    osText = `${v.scoreLeft} (TW-ROP)`;
                }

                let wtText = v.currentWeight ? v.currentWeight + 'g' : '--';

                // Format Red for TW-ROP or AROP
                if (v.scoreRight >= 55 || (v.od && v.od.arop)) {
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(220, 38, 38);
                } else {
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(29, 78, 216);
                }
                doc.text(`${odText}`, 60, y);

                if (v.scoreLeft >= 55 || (v.os && v.os.arop)) {
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(220, 38, 38);
                } else {
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(21, 128, 61);
                }
                doc.text(`${osText}`, 95, y);

                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                doc.text(`${wtText}`, 130, y);
                
                y += 6;
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
            });
            
            y += 15;
            doc.setFontSize(12);
            doc.setTextColor(140, 21, 21); // Stanford Cardinal link
            doc.textWithLink("→ Click here to open this interactive chart in your browser", 14, y, { url: shareLink });
            
            y += 6;
            doc.setFontSize(8);
            doc.setTextColor(156, 163, 175);
            const splitLink = doc.splitTextToSize(shareLink, 180);
            doc.text(splitLink, 14, y);
            
            doc.save(`ROP_Chart_${exportPt.id}.pdf`);
        }

        // --- VISIT DATA ENTRY LOGIC --- //
        function updateCalc() {
            // OD
            const odArop = document.getElementById('od-arop').checked;
            if (odArop) {
                odCalculatedScore = 85;
                document.getElementById('od-calc-score').innerText = 85;
            } else {
                const odZone = document.querySelector('input[name="od-zone"]:checked');
                const odStage = document.querySelector('input[name="od-stage"]:checked');
                const odPlus = document.querySelector('input[name="od-plus"]:checked');

                if (odZone && odStage && odPlus) {
                    const sum = parseInt(odZone.value) + parseInt(odStage.value) + parseInt(odPlus.value);
                    odCalculatedScore = Math.min(85, sum); 
                    document.getElementById('od-calc-score').innerText = odCalculatedScore;
                } else {
                    odCalculatedScore = null;
                    document.getElementById('od-calc-score').innerText = '--';
                }
            }

            // OS
            const osArop = document.getElementById('os-arop').checked;
            if (osArop) {
                osCalculatedScore = 85;
                document.getElementById('os-calc-score').innerText = 85;
            } else {
                const osZone = document.querySelector('input[name="os-zone"]:checked');
                const osStage = document.querySelector('input[name="os-stage"]:checked');
                const osPlus = document.querySelector('input[name="os-plus"]:checked');

                if (osZone && osStage && osPlus) {
                    const sum = parseInt(osZone.value) + parseInt(osStage.value) + parseInt(osPlus.value);
                    osCalculatedScore = Math.min(85, sum); 
                    document.getElementById('os-calc-score').innerText = osCalculatedScore;
                } else {
                    osCalculatedScore = null;
                    document.getElementById('os-calc-score').innerText = '--';
                }
            }
        }

        function clearRadios(eye) {
            document.getElementById(`${eye}-arop`).checked = false;
            document.getElementById(`${eye}-pscore`).value = "";
            const radios = document.querySelectorAll(`input[name^="${eye}-"]`);
            radios.forEach(radio => radio.checked = false);
            updateCalc();
        }

        document.getElementById('new-visit-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const w = parseInt(document.getElementById('visit-weeks').value);
            const d = parseInt(document.getElementById('visit-days').value);
            const currentWeight = document.getElementById('visit-weight').value;
            
            const odArop = document.getElementById('od-arop').checked;
            const odZone = document.querySelector('input[name="od-zone"]:checked');
            const odStage = document.querySelector('input[name="od-stage"]:checked');
            const odPlus = document.querySelector('input[name="od-plus"]:checked');
            const odPScore = document.getElementById('od-pscore').value;
            
            const osArop = document.getElementById('os-arop').checked;
            const osZone = document.querySelector('input[name="os-zone"]:checked');
            const osStage = document.querySelector('input[name="os-stage"]:checked');
            const osPlus = document.querySelector('input[name="os-plus"]:checked');
            const osPScore = document.getElementById('os-pscore').value;

            const odHasAny = odArop || odZone || odStage || odPlus || odPScore !== "";
            const osHasAny = osArop || osZone || osStage || osPlus || osPScore !== "";

            if (!odHasAny && !osHasAny) {
                alert("Please select Zone/Stage/Plus, AROP, or a P-Score for at least one eye.");
                return;
            }
            if (odHasAny && !odArop && !(odZone && odStage && odPlus)) {
                alert("Please complete all three parameters for the Right Eye (OD), or select AROP.");
                return;
            }
            if (osHasAny && !osArop && !(osZone && osStage && osPlus)) {
                alert("Please complete all three parameters for the Left Eye (OS), or select AROP.");
                return;
            }

            const pmaDecimal = w + (d / 7);
            const pt = patients.find(p => p.id === currentPatientId);
            
            const newVisitData = { 
                weeks: w, 
                days: d, 
                pmaDecimal: pmaDecimal, 
                currentWeight: currentWeight ? parseInt(currentWeight) : null,
                scoreRight: odHasAny ? odCalculatedScore : null,
                scoreLeft: osHasAny ? osCalculatedScore : null,
                od: { arop: odArop, pscore: odPScore, zone: odZone ? odZone.value : null, stage: odStage ? odStage.value : null, plus: odPlus ? odPlus.value : null },
                os: { arop: osArop, pscore: osPScore, zone: osZone ? osZone.value : null, stage: osStage ? osStage.value : null, plus: osPlus ? osPlus.value : null }
            };

            if (editingVisitIndex !== null) {
                pt.visits[editingVisitIndex] = newVisitData;
                cancelVisitEdit();
            } else {
                pt.visits.push(newVisitData);
            }
            
            pt.visits.sort((a, b) => a.pmaDecimal - b.pmaDecimal);
            
            if (editingVisitIndex === null) {
                clearRadios('od');
                clearRadios('os');
                document.getElementById('new-visit-form').reset();
            }

            renderVisits();
            updateChart();
        });

        function editVisit(index) {
            editingVisitIndex = index;
            const pt = patients.find(p => p.id === currentPatientId);
            const visit = pt.visits[index];

            document.getElementById('visit-weeks').value = visit.weeks;
            document.getElementById('visit-days').value = visit.days;
            document.getElementById('visit-weight').value = visit.currentWeight || '';

            clearRadios('od');
            clearRadios('os');

            if (visit.od) {
                document.getElementById('od-arop').checked = visit.od.arop || false;
                document.getElementById('od-pscore').value = visit.od.pscore || "";
                if (visit.od.zone !== null) { const el = document.querySelector(`input[name="od-zone"][value="${visit.od.zone}"]`); if (el) el.checked = true; }
                if (visit.od.stage !== null) { const el = document.querySelector(`input[name="od-stage"][value="${visit.od.stage}"]`); if (el) el.checked = true; }
                if (visit.od.plus !== null) { const el = document.querySelector(`input[name="od-plus"][value="${visit.od.plus}"]`); if (el) el.checked = true; }
            }

            if (visit.os) {
                document.getElementById('os-arop').checked = visit.os.arop || false;
                document.getElementById('os-pscore').value = visit.os.pscore || "";
                if (visit.os.zone !== null) { const el = document.querySelector(`input[name="os-zone"][value="${visit.os.zone}"]`); if (el) el.checked = true; }
                if (visit.os.stage !== null) { const el = document.querySelector(`input[name="os-stage"][value="${visit.os.stage}"]`); if (el) el.checked = true; }
                if (visit.os.plus !== null) { const el = document.querySelector(`input[name="os-plus"][value="${visit.os.plus}"]`); if (el) el.checked = true; }
            }

            updateCalc();

            visitFormTitle.innerText = `Edit Visit: ${visit.weeks}w ${visit.days}d`;
            submitVisitBtn.innerText = "Update Visit";
            cancelVisitBtn.classList.remove('hidden');
        }

        function cancelVisitEdit() {
            editingVisitIndex = null;
            document.getElementById('new-visit-form').reset();
            clearRadios('od');
            clearRadios('os');

            visitFormTitle.innerText = "Log New Visit";
            submitVisitBtn.innerText = "Add Data Point";
            cancelVisitBtn.classList.add('hidden');
        }

        function renderVisits() {
            visitListBody.innerHTML = '';
            const pt = patients.find(p => p.id === currentPatientId);
            
            pt.visits.forEach((v, index) => {
                let rightDisplay = v.scoreRight !== null ? v.scoreRight : '--';
                if (v.od && v.od.arop) {
                    rightDisplay = '<span class="text-red-600 font-bold">85 (AROP)</span>';
                } else if (v.scoreRight >= 55) {
                    rightDisplay = `<span class="text-red-600 font-bold">${v.scoreRight} (TW-ROP)</span>`;
                }
                
                let leftDisplay = v.scoreLeft !== null ? v.scoreLeft : '--';
                if (v.os && v.os.arop) {
                    leftDisplay = '<span class="text-red-600 font-bold">85 (AROP)</span>';
                } else if (v.scoreLeft >= 55) {
                    leftDisplay = `<span class="text-red-600 font-bold">${v.scoreLeft} (TW-ROP)</span>`;
                }

                let weightDisplay = v.currentWeight ? `<span class="font-medium text-gray-900">${v.currentWeight}g</span>` : '<span class="text-gray-400">--</span>';

                const tr = document.createElement('tr');
                tr.className = `border-b transition ${editingVisitIndex === index ? 'bg-blue-50' : 'hover:bg-gray-50'}`;
                tr.innerHTML = `
                    <td class="p-3 text-sm">${v.weeks}w ${v.days}d</td>
                    <td class="p-3 text-sm font-semibold text-blue-700">${rightDisplay}</td>
                    <td class="p-3 text-sm font-semibold text-green-700">${leftDisplay}</td>
                    <td class="p-3 text-sm">${weightDisplay}</td>
                    <td class="p-3 text-sm text-right">
                        <button onclick="editVisit(${index})" class="text-[#8C1515] hover:text-[#731010] mr-4 font-semibold">Edit</button>
                        <button onclick="removeVisit(${index})" class="text-red-500 hover:text-red-700 font-semibold">Remove</button>
                    </td>
                `;
                visitListBody.appendChild(tr);
            });
        }

        function removeVisit(index) {
            if (confirm("Are you sure you want to remove this visit?")) {
                const pt = patients.find(p => p.id === currentPatientId);
                pt.visits.splice(index, 1);
                
                if (editingVisitIndex === index) {
                    cancelVisitEdit();
                } else if (editingVisitIndex !== null && index < editingVisitIndex) {
                    editingVisitIndex--; 
                }
                renderVisits();
                updateChart();
            }
        }

        // --- CHART PREDICTION MAPPING --- //
        function getPatientThresholdCurve(pt, parsedData) {
            if (!parsedData) return null; 

            let ega = pt.egaWeeks;
            if (ega < 22) ega = 22;
            if (ega > 32) ega = 32;
            
            let bw = Math.round(pt.bw / 100) * 100;
            if (bw < 400) bw = 400;
            if (bw > 1500) bw = 1500;
            
            const sex = pt.sex; 
            
            if (parsedData[ega] && parsedData[ega][bw] && parsedData[ega][bw][sex]) {
                const pmaData = parsedData[ega][bw][sex];
                const chartPoints = [];
                for(let p = 30; p <= 40; p++) {
                    chartPoints.push({ x: p, y: pmaData[p] });
                }
                return chartPoints;
            }
            return null;
        }

        // --- CHART RENDERING --- //
        function updateChart() {
            const pt = patients.find(p => p.id === currentPatientId);
            
            const rightEyeData = pt.visits.filter(v => v.scoreRight !== null).map(v => ({ x: v.pmaDecimal, y: v.scoreRight }));
            const leftEyeData = pt.visits.filter(v => v.scoreLeft !== null).map(v => ({ x: v.pmaDecimal, y: v.scoreLeft }));

            const curve1w = getPatientThresholdCurve(pt, thresholdData1w);
            const curve2w = getPatientThresholdCurve(pt, thresholdData2w);

            if (chartInstance) {
                chartInstance.destroy();
            }

            const ctx = document.getElementById('ropChart').getContext('2d');
            const chartDatasets = [];

            // 1. Draw 2-Week Threshold FIRST (Bottom layer)
            if (curve2w) {
                chartDatasets.push({
                    label: 'Moderate risk',
                    data: curve2w,
                    borderColor: 'rgba(234, 179, 8, 1)', 
                    backgroundColor: 'rgba(234, 179, 8, 0.15)', // Highly transparent Yellow
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    fill: '+1', // ONLY fills up to the line strictly above it
                    tension: 0.4,
                    showLine: true
                });
            }

            // 2. Draw 1-Week Threshold NEXT (Middle layer)
            if (curve1w) {
                chartDatasets.push({
                    label: 'High risk',
                    data: curve1w,
                    borderColor: 'rgba(249, 115, 22, 1)', 
                    backgroundColor: 'rgba(249, 115, 22, 0.15)', // Highly transparent Orange
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    fill: '+1', // ONLY fills up to the Red line
                    tension: 0.4,
                    showLine: true
                });
            }

            const txWarrantedData = [];
            for (let p = 30; p <= 40; p++) {
                txWarrantedData.push({x: p, y: 55});
            }

            // 3. Draw Absolute Treatment Warranted Threshold LAST of the backgrounds (Top layer)
            chartDatasets.push({
                label: 'Treatment Warranted (≥ 55)',
                data: txWarrantedData,
                borderColor: 'rgba(239, 68, 68, 1)', 
                backgroundColor: 'rgba(239, 68, 68, 0.15)', // Highly transparent Red
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                pointHoverRadius: 0,
                fill: 'end', // Fills up to the top boundary of the chart
                tension: 0, 
                showLine: true
            });

            // 4. Draw Right Eye Data (Drawn ON TOP of all shadings)
            chartDatasets.push({
                label: 'Right Eye (OD)',
                data: rightEyeData,
                borderColor: '#1d4ed8', 
                backgroundColor: '#1d4ed8',
                borderWidth: 2,
                borderDash: [], 
                pointRadius: 5,
                pointHoverRadius: 7,
                showLine: true,
                tension: 0.4
            });

            // 5. Draw Left Eye Data (Drawn ON TOP of all shadings)
            chartDatasets.push({
                label: 'Left Eye (OS)',
                data: leftEyeData,
                borderColor: '#15803d', 
                backgroundColor: '#15803d',
                borderWidth: 2,
                borderDash: [], 
                pointRadius: 5,
                pointHoverRadius: 7,
                showLine: true,
                tension: 0.4
            });

            chartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: chartDatasets
                },
                plugins: [customCanvasBackgroundColor], 
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                filter: function(item, chart) {
                                    // Remove OD and OS lines from the interactive legend entirely
                                    return !item.text.includes('Eye');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Post Menstrual Age (Weeks)', font: {weight: 'bold'} },
                            min: 30,
                            max: 40, 
                            ticks: { stepSize: 1 }
                        },
                        y: {
                            title: { display: true, text: 'tROP-SS', font: {weight: 'bold'} },
                            min: 0,
                            max: 90 
                        }
                    }
                }
            });
        }

        // --- IMPORT & EXPORT LOGIC --- //
        const zMap = { "30": "ZI", "20": "PZII", "15": "ZII" };
        const sMap = { "0": "0", "3": "1", "10": "2", "25": "3" };
        const pMap = { "0": "None", "5": "Pre", "30": "Plus" };

        const zMapRev = { "ZI": "30", "PZII": "20", "ZII": "15" };
        const sMapRev = { "0": "0", "1": "3", "2": "10", "3": "25" };
        const pMapRev = { "NONE": "0", "PRE": "5", "PLUS": "30" };

        function exportCSV() {
            let csvContent = "Patient ID,EGA Week,EGA Day,Sex,Birth Weight,Visit PMA Week,Visit PMA Day,Current Weight,OD Zone,OD Stage,OD Plus,OD AROP,OD P Score,OS Zone,OS Stage,OS Plus,OS AROP,OS P Score\n";

            patients.forEach(pt => {
                if (pt.visits.length === 0) {
                    csvContent += `${pt.id},${pt.egaWeeks},${pt.egaDays},${pt.sex},${pt.bw},,,,,,,,,,,,,\n`;
                } else {
                    pt.visits.forEach(v => {
                        const w = v.currentWeight || "";
                        
                        const odZ = v.od && v.od.zone ? zMap[v.od.zone] : "";
                        const odS = v.od && v.od.stage ? sMap[v.od.stage] : "";
                        const odP = v.od && v.od.plus ? pMap[v.od.plus] : "";
                        const odA = v.od && v.od.arop ? "TRUE" : "FALSE";
                        const odPS = v.od && v.od.pscore ? v.od.pscore : "";

                        const osZ = v.os && v.os.zone ? zMap[v.os.zone] : "";
                        const osS = v.os && v.os.stage ? sMap[v.os.stage] : "";
                        const osP = v.os && v.os.plus ? pMap[v.os.plus] : "";
                        const osA = v.os && v.os.arop ? "TRUE" : "FALSE";
                        const osPS = v.os && v.os.pscore ? v.os.pscore : "";
                        
                        csvContent += `${pt.id},${pt.egaWeeks},${pt.egaDays},${pt.sex},${pt.bw},${v.weeks},${v.days},${w},${odZ},${odS},${odP},${odA},${odPS},${osZ},${osS},${osP},${osA},${osPS}\n`;
                    });
                }
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "rop_patients_data.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n').map(row => row.trim()).filter(row => row);
                if (rows.length < 2) {
                    alert("CSV is empty or invalid.");
                    return;
                }

                const headers = rows[0].split(',').map(h => h.trim().toUpperCase());
                const isNewFormat = headers.includes("CURRENT WEIGHT");

                let newPatientsMap = {};

                for (let i = 1; i < rows.length; i++) {
                    const cols = rows[i].split(',').map(c => c.trim());
                    const ptId = cols[0];
                    if (!ptId) continue;

                    if (!newPatientsMap[ptId]) {
                        newPatientsMap[ptId] = {
                            id: ptId,
                            egaWeeks: parseInt(cols[1]) || 0,
                            egaDays: parseInt(cols[2]) || 0,
                            sex: cols[3] || "M",
                            bw: parseInt(cols[4]) || 0,
                            visits: []
                        };
                    }

                    if (cols[5] && cols[5] !== "") {
                        const vWeeks = parseInt(cols[5]);
                        const vDays = parseInt(cols[6] || "0");
                        const pmaDecimal = vWeeks + (vDays / 7);

                        let curWt = null, odZ, odS, odP, odA, odPS, osZ, osS, osP, osA, osPS;

                        const mapVal = (val, map) => val ? (map[val.toUpperCase()] || null) : null;

                        if (isNewFormat) {
                            curWt = cols[7] ? parseInt(cols[7]) : null;
                            odZ = mapVal(cols[8], zMapRev);
                            odS = mapVal(cols[9], sMapRev);
                            odP = mapVal(cols[10], pMapRev);
                            odA = cols[11] === "TRUE";
                            odPS = cols[12] || null;

                            osZ = mapVal(cols[13], zMapRev);
                            osS = mapVal(cols[14], sMapRev);
                            osP = mapVal(cols[15], pMapRev);
                            osA = cols[16] === "TRUE";
                            osPS = cols[17] || null;
                        } else {
                            odZ = mapVal(cols[7], zMapRev);
                            odS = mapVal(cols[8], sMapRev);
                            odP = cols[9] === "AROP" ? null : mapVal(cols[9], pMapRev);
                            odA = cols[9] === "AROP";
                            odPS = null;

                            osZ = mapVal(cols[10], zMapRev);
                            osS = mapVal(cols[11], sMapRev);
                            osP = cols[12] === "AROP" ? null : mapVal(cols[12], pMapRev);
                            osA = cols[12] === "AROP";
                            osPS = null;
                        }

                        let scoreRight = null;
                        if (odA) scoreRight = 85;
                        else if (odZ && odS && odP) scoreRight = Math.min(85, parseInt(odZ) + parseInt(odS) + parseInt(odP));

                        let scoreLeft = null;
                        if (osA) scoreLeft = 85;
                        else if (osZ && osS && osP) scoreLeft = Math.min(85, parseInt(osZ) + parseInt(osS) + parseInt(osP));

                        newPatientsMap[ptId].visits.push({
                            weeks: vWeeks,
                            days: vDays,
                            pmaDecimal: pmaDecimal,
                            currentWeight: curWt,
                            scoreRight: scoreRight,
                            scoreLeft: scoreLeft,
                            od: { zone: odZ, stage: odS, plus: odP, arop: odA, pscore: odPS },
                            os: { zone: osZ, stage: osS, plus: osP, arop: osA, pscore: osPS }
                        });
                    }
                }

                const newPts = Object.values(newPatientsMap);
                newPts.forEach(importedPt => {
                    const existingIdx = patients.findIndex(p => p.id === importedPt.id);
                    if(existingIdx >= 0) {
                        patients[existingIdx] = importedPt; 
                    } else {
                        patients.push(importedPt);
                    }
                });
                
                patients.forEach(pt => {
                    pt.visits.sort((a, b) => a.pmaDecimal - b.pmaDecimal);
                });

                renderDashboard();
                alert("Data successfully imported!");
                event.target.value = ''; 
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>